---
- name: Set environment proxy variables if defined
  lineinfile:
    path: /etc/environment
    line: "{{ item }}"
    create: yes
    state: present
  loop:
    - "http_proxy={{ http_proxy }}"
    - "https_proxy={{ https_proxy }}"
    - "no_proxy={{ no_proxy }}"
  when: http_proxy is defined and https_proxy is defined and no_proxy is defined
  tags: cri

- name: Add CRI-O repository (OBS)
  apt_key:
    url: "https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_22.04/Release.key"
    state: present
  tags: cri

- name: Add CRI-O repository key
  apt_key:
    url: "https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/1.28/xUbuntu_22.04/Release.key"
    state: present
  tags: cri

- name: Add CRI-O stable repo
  apt_repository:
    repo: "deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_22.04/ /"
    filename: "devel:kubic:libcontainers:stable"
  tags: cri

- name: Add CRI-O version-specific repo
  apt_repository:
    repo: "deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/1.28/xUbuntu_22.04/ /"
    filename: "devel:kubic:libcontainers:stable:cri-o:1.28"
  tags: cri

- name: Install CRI-O and dependencies
  apt:
    name:
      - cri-o
      - cri-o-runc
    update_cache: yes
    state: present
  tags: cri

- name: Enable and start CRI-O
  systemd:
    name: crio
    enabled: yes
    state: started
  tags: cri

- name: Set proxy for CRI-O systemd service if defined
  blockinfile:
    path: /etc/systemd/system/crio.service.d/proxy.conf
    create: yes
    block: |
      [Service]
      {% if http_proxy is defined %}
      Environment="http_proxy={{ http_proxy }}"
      {% endif %}
      {% if https_proxy is defined %}
      Environment="https_proxy={{ https_proxy }}"
      {% endif %}
      {% if no_proxy is defined %}
      Environment="NO_PROXY={{ no_proxy }}"
      {% endif %}
  when: http_proxy is defined or https_proxy is defined or no_proxy is defined
  tags: cri

- name: Reload systemd
  shell: sudo systemctl daemon-reload
  tags: cri

- name: Restart CRI-O
  service:
    name: crio
    state: restarted
  tags: cri
