ARG GOLANG_IMAGE_TAG RUNTIME_IMAGE_TAG PUBLIC_IMAGE_REPO_URL GOPROXY
FROM ${PUBLIC_IMAGE_REPO_URL}/golang:${GOLANG_IMAGE_TAG} AS builder

ENV GOPROXY=https://goproxy.io,direct
WORKDIR /go/src/
COPY go.mod go.sum ./
ARG PROJECT_BINARY_NAME CGO_ENABLE GO_OS GO_ARCH GC_FLAGS MAIN_PROJECT_ADDRESS
RUN CGO_ENABLED=${CGO_ENABLE} GOOS=${GO_OS} GOARCH=${GO_ARCH} go mod tidy
COPY . .
RUN CGO_ENABLED=${CGO_ENABLE} GOOS=${GO_OS} GOARCH=${GO_ARCH} go build -o bin/${PROJECT_BINARY_NAME} ${MAIN_PROJECT_ADDRESS}
ARG PUBLIC_IMAGE_REPO_URL RUNTIME_IMAGE_TAG
FROM ${PUBLIC_IMAGE_REPO_URL}/alpine:${RUNTIME_IMAGE_TAG}
WORKDIR /app
COPY --from=builder /go/src/bin/url-shortner /app/url-shortner
ENTRYPOINT ["/app/url-shortner"]
